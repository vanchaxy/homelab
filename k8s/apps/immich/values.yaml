cloudnative-pg:
  config:
    clusterWide: false

immich:
  controllers:
    main:
      containers:
        main:
          env:
            DB_HOSTNAME:
              valueFrom:
                secretKeyRef:
                  name: immich-postgres-app
                  key: host
            DB_USERNAME:
              valueFrom:
                secretKeyRef:
                  name: immich-postgres-user
                  key: username
            DB_DATABASE_NAME:
              valueFrom:
                secretKeyRef:
                  name: immich-postgres-app
                  key: dbname
            DB_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: immich-postgres-user
                  key: password

  immich:
    persistence:
      library:
        existingClaim: photo-library

  valkey:
    enabled: true
    persistence:
      data:
        enabled: true
        size: 1Gi
        storageClass: longhorn-ssd
        accessMode: ReadWriteOnce

  server:
    controllers:
      main:
        strategy: Recreate
        containers:
          main:
            image:
              repository: ghcr.io/immich-app/immich-server
              tag: v2.5.5@sha256:161b1ec8af9e0478797cfd75ea857c7e55af271fa7cea103cb30ab1ba5b418d8
    route:
      main:
        hostnames:
          - immich.ivanchenko.io
        parentRefs:
          - name: internal-gw
            namespace: envoy-gateway
            sectionName: https


  machine-learning:
    enabled: true
    controllers:
      main:
        containers:
          main:
            image:
              repository: ghcr.io/immich-app/immich-machine-learning
              tag: v2.5.5@sha256:2e17e15855907ece0d5b3a7bf625b12f6d987a5854fa71d888641acae28b0323

helpers:
  infisicalSecrets:
    - name: immich-postgres-user
      infisical:
        path: "/immich/postgres-user"
  backups:
    - pvcName: photo-library
      resticRepoSuffix: photo-library
      schedule: "0 0 * * *"
      retain:
        daily: 5
        weekly: 4
        monthly: 2
        yearly: 1
    - pvcName: immich-postgres-1
      resticRepoSuffix: immich/postgres
      schedule: "0 0 * * *"
      retain:
        daily: 5
        weekly: 4
        monthly: 2
        yearly: 1
      moverSecurityContext:
        fsGroup: 26
        runAsGroup: 26
        runAsNonRoot: true
        runAsUser: 26
